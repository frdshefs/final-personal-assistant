name: –ì–ª–∞–≤–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

on:
  schedule:
    - cron: '0 8 * * *'
    - cron: '0 12 * * *'
    - cron: '0 18 * * *'
    - cron: '0 21 * * *'
    - cron: '0 20 * * 0'
  workflow_dispatch:
    inputs:
      mode:
        description: '–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'
        required: true
        type: choice
        options:
          - —É—Ç—Ä–æ
          - –¥–µ–Ω—å
          - –≤–µ—á–µ—Ä
          - –æ—Ç—á–µ—Ç
          - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

jobs:
  main-processor:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è —Å—É—Ç–æ–∫
        id: time_of_day
        run: |
          HOUR=$(date +%H)
          if [ $HOUR -ge 6 ] && [ $HOUR -lt 12 ]; then
            echo "period=—É—Ç—Ä–æ" >> $GITHUB_OUTPUT
            echo "greeting=–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!" >> $GITHUB_OUTPUT
          elif [ $HOUR -ge 12 ] && [ $HOUR -lt 18 ]; then
            echo "period=–¥–µ–Ω—å" >> $GITHUB_OUTPUT
            echo "greeting=–î–æ–±—Ä—ã–π –¥–µ–Ω—å!" >> $GITHUB_OUTPUT
          elif [ $HOUR -ge 18 ] && [ $HOUR -lt 22 ]; then
            echo "period=–≤–µ—á–µ—Ä" >> $GITHUB_OUTPUT
            echo "greeting=–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!" >> $GITHUB_OUTPUT
          else
            echo "period=–Ω–æ—á—å" >> $GITHUB_OUTPUT
            echo "greeting=–î–æ–±—Ä–æ–π –Ω–æ—á–∏!" >> $GITHUB_OUTPUT
          fi
          echo "today=$(date +"%d.%m.%Y")" >> $GITHUB_OUTPUT
          echo "weekday=$(date +%A)" >> $GITHUB_OUTPUT
          echo "current_time=$(date +"%H:%M")" >> $GITHUB_OUTPUT

      - name: –í—ã–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        id: select_messages
        run: |
          GREETINGS_COUNT=$(jq -r '.greetings | length' messages_database.json)
          GREETING_INDEX=$((RANDOM % GREETINGS_COUNT))
          GREETING=$(jq -r ".greetings[$GREETING_INDEX]" messages_database.json)
          
          MOTIVATION_COUNT=$(jq -r '.motivation | length' messages_database.json)
          MOTIVATION_INDEX=$((RANDOM % MOTIVATION_COUNT))
          MOTIVATION=$(jq -r ".motivation[$MOTIVATION_INDEX]" messages_database.json)
          
          TIPS_COUNT=$(jq -r '.tips | length' messages_database.json)
          TIP_INDEX=$((RANDOM % TIPS_COUNT))
          TIP=$(jq -r ".tips[$TIP_INDEX]" messages_database.json)
          
          echo "greeting=$GREETING" >> $GITHUB_OUTPUT
          echo "motivation=$MOTIVATION" >> $GITHUB_OUTPUT
          echo "tip=$TIP" >> $GITHUB_OUTPUT

      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        id: check_stats
        run: |
          if [ -f "stats.json" ]; then
            DAYS_ACTIVE=$(jq -r '.days_active' stats.json)
            TASKS_COMPLETED=$(jq -r '.tasks_completed' stats.json)
            PRODUCTIVITY_SCORE=$(jq -r '.productivity_score' stats.json)
            STREAK_DAYS=$(jq -r '.streak_days' stats.json)
            echo "has_stats=true" >> $GITHUB_OUTPUT
            echo "days_active=$DAYS_ACTIVE" >> $GITHUB_OUTPUT
            echo "tasks_completed=$TASKS_COMPLETED" >> $GITHUB_OUTPUT
            echo "productivity_score=$PRODUCTIVITY_SCORE" >> $GITHUB_OUTPUT
            echo "streak_days=$STREAK_DAYS" >> $GITHUB_OUTPUT
          else
            echo "has_stats=false" >> $GITHUB_OUTPUT
          fi

      - name: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥
        id: determine_period
        run: |
          if [ -n "${{ github.event.inputs.mode }}" ]; then
            echo "period=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          else
            echo "period=${{ steps.time_of_day.outputs.period }}" >> $GITHUB_OUTPUT
          fi

      - name: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        id: generate_content
        run: |
          PERIOD="${{ steps.determine_period.outputs.period }}"
          
          case $PERIOD in
            "—É—Ç—Ä–æ")
              CONTENT="üìÖ –ü–õ–ê–ù –ù–ê –î–ï–ù–¨"
              CONTENT="$CONTENT
1Ô∏è‚É£ –°–∞–º–∞—è –≤–∞–∂–Ω–∞—è –∑–∞–¥–∞—á–∞: 
2Ô∏è‚É£ –í—Ç–æ—Ä–∞—è –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏: 
3Ô∏è‚É£ –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤—Ä–µ–º—è: 

‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:
‚Ä¢ –£—Ç—Ä–æ (–¥–æ 12:00): 
‚Ä¢ –î–µ–Ω—å (12:00-18:00): 
‚Ä¢ –í–µ—á–µ—Ä (–ø–æ—Å–ª–µ 18:00): "
              ;;
            "–¥–µ–Ω—å")
              CONTENT="üïõ –°–ï–†–ï–î–ò–ù–ê –î–ù–Ø - –ü–†–û–í–ï–†–ö–ê"
              CONTENT="$CONTENT
‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ:
1. 
2. 

üìù –ß—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:
1. 
2. 

‚òï –ù—É–∂–µ–Ω –ø–µ—Ä–µ—Ä—ã–≤? –°–¥–µ–ª–∞–π –ø–∞—É–∑—É 5-10 –º–∏–Ω—É—Ç!"
              ;;
            "–≤–µ—á–µ—Ä")
              CONTENT="üåô –í–ï–ß–ï–†–ù–Ø–Ø –†–ï–§–õ–ï–ö–°–ò–Ø"
              CONTENT="$CONTENT
üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è:
1. 
2. 

üéì –ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è:
‚Ä¢ 

üìã –ù–∞ –∑–∞–≤—Ç—Ä–∞:
1. "
              ;;
            "–æ—Ç—á–µ—Ç")
              CONTENT="üìä –ù–ï–î–ï–õ–¨–ù–´–ô –û–¢–ß–ï–¢"
              CONTENT="$CONTENT
üèÜ –°–∞–º—ã–µ –±–æ–ª—å—à–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
1. 
2. 

üéØ –¶–µ–ª–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é:
1. 
2. 

üí° –ì–ª–∞–≤–Ω—ã–π —É—Ä–æ–∫ –Ω–µ–¥–µ–ª–∏:
‚Ä¢ "
              ;;
            "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
              CONTENT="üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê"
              CONTENT="$CONTENT
–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞..."
              ;;
            *)
              CONTENT="‚öôÔ∏è –†–ï–ñ–ò–ú: $PERIOD"
              CONTENT="$CONTENT
–ß—Ç–æ –±—ã —Ç—ã —Ö–æ—Ç–µ–ª —Å–¥–µ–ª–∞—Ç—å?
‚Ä¢ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏
‚Ä¢ –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ª–∏
‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç"
              ;;
          esac
          
          echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.time_of_day.outputs.greeting }}
            ${{ steps.select_messages.outputs.greeting }}
            
            üìÖ ${{ steps.time_of_day.outputs.weekday }}, ${{ steps.time_of_day.outputs.today }}
            ‚è∞ –°–µ–π—á–∞—Å: ${{ steps.time_of_day.outputs.current_time }}
            
            ${{ steps.generate_content.outputs.content }}
            
            üí° –°–æ–≤–µ—Ç:
            ${{ steps.select_messages.outputs.tip }}
            
            üí™ ${{ steps.select_messages.outputs.motivation }}
            
            @if (steps.check_stats.outputs.has_stats == 'true')
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
            üìÖ –î–Ω–µ–π —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º: ${{ steps.check_stats.outputs.days_active }}
            ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á: ${{ steps.check_stats.outputs.tasks_completed }}
            üìà –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${{ steps.check_stats.outputs.productivity_score }}/100
            üî• –°–µ—Ä–∏—è –¥–Ω–µ–π: ${{ steps.check_stats.outputs.streak_days }}
            
            –•–æ—Ä–æ—à–µ–≥–æ ${{ steps.determine_period.outputs.period }}–∞!
            –û—Ç–≤–µ—Ç—å –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–≤–æ–∏–º–∏ –ø–ª–∞–Ω–∞–º–∏!

      - name: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        run: |
          if [ -f "stats.json" ]; then
            DAYS_ACTIVE=$(jq -r '.days_active' stats.json)
            NEW_DAYS=$((DAYS_ACTIVE + 1))
            jq --argjson days "$NEW_DAYS" '.days_active = $days' stats.json > temp_stats.json
            mv temp_stats.json stats.json
          else
            echo '{"days_active": 1, "tasks_completed": 0, "goals_achieved": 0, "productivity_score": 0, "streak_days": 0}' > stats.json
          fi
          
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add stats.json
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push || echo "–ù–µ—á–µ–≥–æ –ø—É—à–∏—Ç—å"
