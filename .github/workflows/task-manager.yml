name: ‚òë –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞—á

on:
  workflow_dispatch:
    inputs:
      action:
        description: –î–µ–π—Å—Ç–≤–∏–µ
        required: true
        type: choice
        options:
          - –¥–æ–±–∞–≤–∏—Ç—å
          - —Å–ø–∏—Å–æ–∫
          - –∑–∞–≤–µ—Ä—à–∏—Ç—å
          - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      task:
        description: '–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)'
        required: false
        type: string
      category:
        description: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'
        required: false
        type: choice
        options:
          - —É—á–µ–±–∞
          - –ª–∏—á–Ω–æ–µ
          - —Ä–∞–±–æ—Ç–∞
      priority:
        description: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        required: false
        type: choice
        options:
          - –≤—ã—Å–æ–∫–∏–π
          - —Å—Ä–µ–¥–Ω–∏–π
          - –Ω–∏–∑–∫–∏–π

jobs:
  manage-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        id: process_action
        run: |
          ACTION="${{ github.event.inputs.action }}"
          TASK="${{ github.event.inputs.task }}"
          CATEGORY="${{ github.event.inputs.category }}"
          PRIORITY="${{ github.event.inputs.priority }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∑–∞–¥–∞—á
          if [ ! -f "tasks.json" ]; then
            echo '{"tasks": [], "last_update": "", "total_completed": 0}' > tasks.json
          fi
          
          case $ACTION in
            "–¥–æ–±–∞–≤–∏—Ç—å")
              if [ -z "$TASK" ]; then
                echo "message=–ù–µ —É–∫–∞–∑–∞–Ω–∞ –∑–∞–¥–∞—á–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è" >> $GITHUB_OUTPUT
                exit 0
              fi
              
              # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞–¥–∞—á–∏
              TASK_ID="task_$(date +%s)"
              
              # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É
              jq --arg id "$TASK_ID" \
                 --arg task "$TASK" \
                 --arg category "${CATEGORY:-–Ω–µ —É–∫–∞–∑–∞–Ω–∞}" \
                 --arg priority "${PRIORITY:-—Å—Ä–µ–¥–Ω–∏–π}" \
                 --arg created "$(date +"%Y-%m-%d %H:%M:%S")" \
                 --arg status "–Ω–µ –Ω–∞—á–∞—Ç–æ" \
                 '.tasks += [{"id": $id, "task": $task, "category": $category, "priority": $priority, "created": $created, "status": $status}] | .last_update = $created' \
                 tasks.json > temp_tasks.json
              mv temp_tasks.json tasks.json
              
              echo "message=‚úì –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: **$TASK**" >> $GITHUB_OUTPUT
              ;;
              
            "—Å–ø–∏—Å–æ–∫")
              # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
              TASK_COUNT=$(jq -r '.tasks | length' tasks.json)
              
              if [ $TASK_COUNT -eq 0 ]; then
                echo "message=–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø—É—Å—Ç" >> $GITHUB_OUTPUT
              else
                TASK_LIST=""
                TASK_LIST+="*–°–ü–ò–°–û–ö –ó–ê–î–ê–ß ($TASK_COUNT)*\n\n"
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫
                for i in $(seq 0 $((TASK_COUNT - 1))); do
                  TASK_NAME=$(jq -r ".tasks[$i].task" tasks.json)
                  CATEGORY=$(jq -r ".tasks[$i].category" tasks.json)
                  PRIORITY=$(jq -r ".tasks[$i].priority" tasks.json)
                  STATUS=$(jq -r ".tasks[$i].status" tasks.json)
                  
                  # –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
                  case $STATUS in
                    "–Ω–µ –Ω–∞—á–∞—Ç–æ") EMOJI="üî¥" ;;
                    "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ") EMOJI="üü°" ;;
                    "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ") EMOJI="üü¢" ;;
                    "–æ—Ç–ª–æ–∂–µ–Ω–æ") EMOJI="‚è∏Ô∏è" ;;
                    *) EMOJI="üìå" ;;
                  esac
                  
                  # –≠–º–æ–¥–∑–∏ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                  case $PRIORITY in
                    "–≤—ã—Å–æ–∫–∏–π") PRIORITY_EMOJI="üî∫" ;;
                    "—Å—Ä–µ–¥–Ω–∏–π") PRIORITY_EMOJI="üü°" ;;
                    "–Ω–∏–∑–∫–∏–π") PRIORITY_EMOJI="üîª" ;;
                    *) PRIORITY_EMOJI="üìå" ;;
                  esac
                  
                  TASK_LIST+="$EMOJI $PRIORITY_EMOJI *$TASK_NAME*\n"
                  TASK_LIST+="   –ö–∞—Ç–µ–≥–æ—Ä–∏—è: $CATEGORY | –°—Ç–∞—Ç—É—Å: $STATUS\n\n"
                done
                
                echo "message<<EOF" >> $GITHUB_OUTPUT
                echo "$TASK_LIST" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
              fi
              ;;
              
            "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
              TASK_COUNT=$(jq -r '.tasks | length' tasks.json)
              COMPLETED=$(jq -r '.total_completed' tasks.json)
              LAST_UPDATE=$(jq -r '.last_update' tasks.json)
              
              if [ -z "$LAST_UPDATE" ] || [ "$LAST_UPDATE" = "null" ]; then
                LAST_UPDATE="–Ω–∏–∫–æ–≥–¥–∞"
              fi
              
              STATS_MESSAGE="*–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ê–î–ê–ß*\n\n"
              STATS_MESSAGE+="‚Ä¢ –í—Å–µ–≥–æ –∑–∞–¥–∞—á: $TASK_COUNT\n"
              STATS_MESSAGE+="‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: $COMPLETED\n"
              STATS_MESSAGE+="‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $LAST_UPDATE\n\n"
              
              if [ $TASK_COUNT -gt 0 ]; then
                COMPLETION_RATE=$((COMPLETED * 100 / TASK_COUNT))
                STATS_MESSAGE+="*–ü—Ä–æ–≥—Ä–µ—Å—Å: $COMPLETION_RATE% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ*\n"
                
                if [ $COMPLETION_RATE -ge 80 ]; then
                  STATS_MESSAGE+="–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!\n"
                elif [ $COMPLETION_RATE -ge 50 ]; then
                  STATS_MESSAGE+="–•–æ—Ä–æ—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã! –ú–æ–∂–Ω–æ –ª—É—á—à–µ!\n"
                else
                  STATS_MESSAGE+="–ï—Å—Ç—å –Ω–∞–¥ —á–µ–º –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å! –ù–µ —Å–¥–∞–≤–∞–π—Å—è!\n"
                fi
              fi
              
              echo "message<<EOF" >> $GITHUB_OUTPUT
              echo "$STATS_MESSAGE" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              ;;
              
            *)
              echo "message=‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: $ACTION" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if: steps.process_action.outputs.message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.process_action.outputs.message }}
          parse_mode: markdown

      - name: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if: github.event.inputs.action == '–¥–æ–±–∞–≤–∏—Ç—å'
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add tasks.json
          git commit -m "–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞: ${{ github.event.inputs.task }}" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push || echo "–ù–µ—á–µ–≥–æ –ø—É—à–∏—Ç—å"