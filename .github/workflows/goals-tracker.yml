name: –¢—Ä–µ–∫–µ—Ä —Ü–µ–ª–µ–π

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      goal:
        description: '–ù–æ–≤–∞—è —Ü–µ–ª—å'
        required: false
        type: string
      deadline:
        description: '–°—Ä–æ–∫ (–ì–ì–ì–ì-–ú–ú-–î–î)'
        required: false
        type: string
      type:
        description: '–¢–∏–ø —Ü–µ–ª–∏'
        required: false
        type: choice
        options:
          - –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ
          - —Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ
          - –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ

jobs:
  track-goals:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
        uses: actions/checkout@v4

      - name: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ü–µ–ª–∏
        id: process_goals
        run: |
          if [ ! -f "goals.json" ]; then
            echo '{"goals": [], "achieved": [], "in_progress": []}' > goals.json
          fi
          
          GOAL="${{ github.event.inputs.goal }}"
          DEADLINE="${{ github.event.inputs.deadline }}"
          TYPE="${{ github.event.inputs.type }}"
          
          if [ -n "$GOAL" ]; then
            GOAL_ID="goal_$(date +%s)"
            
            if [ -z "$DEADLINE" ]; then
              DEADLINE="–Ω–µ —É–∫–∞–∑–∞–Ω"
            fi
            
            if [ -z "$TYPE" ]; then
              TYPE="–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ"
            fi
            
            jq --arg id "$GOAL_ID" \
               --arg goal "$GOAL" \
               --arg deadline "$DEADLINE" \
               --arg type "$TYPE" \
               --arg created "$(date +"%Y-%m-%d")" \
               --arg status "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" \
               '.goals += [{"id": $id, "goal": $goal, "deadline": $deadline, "type": $type, "created": $created, "status": $status}] | .in_progress += [$goal]' \
               goals.json > temp_goals.json
            mv temp_goals.json goals.json
            
            echo "message=üéØ –ù–æ–≤–∞—è —Ü–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!
üìù $GOAL
üìÖ –¢–∏–ø: $TYPE
‚è∞ –°—Ä–æ–∫: $DEADLINE" >> $GITHUB_OUTPUT
          else
            GOALS_COUNT=$(jq -r '.goals | length' goals.json)
            ACHIEVED_COUNT=$(jq -r '.achieved | length' goals.json)
            IN_PROGRESS_COUNT=$(jq -r '.in_progress | length' goals.json)
            
            if [ $GOALS_COUNT -eq 0 ]; then
              echo "message=üéØ –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —Ü–µ–ª–µ–π
–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é —Ü–µ–ª—å —á–µ—Ä–µ–∑ workflow_dispatch!" >> $GITHUB_OUTPUT
            else
              MESSAGE="üéØ –¢–í–û–ò –¶–ï–õ–ò
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –í—Å–µ–≥–æ —Ü–µ–ª–µ–π: $GOALS_COUNT
‚Ä¢ –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ: $ACHIEVED_COUNT
‚Ä¢ –í –ø—Ä–æ—Ü–µ—Å—Å–µ: $IN_PROGRESS_COUNT"
              
              if [ $ACHIEVED_COUNT -gt 0 ]; then
                MESSAGE="$MESSAGE
‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏:"
                for i in $(seq 0 $((ACHIEVED_COUNT - 1))); do
                  ACHIEVED_GOAL=$(jq -r ".achieved[$i]" goals.json)
                  MESSAGE="$MESSAGE
‚Ä¢ $ACHIEVED_GOAL"
                done
              fi
              
              if [ $IN_PROGRESS_COUNT -gt 0 ]; then
                MESSAGE="$MESSAGE
üéØ –¶–µ–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ:"
                for i in $(seq 0 $((IN_PROGRESS_COUNT - 1))); do
                  IN_PROGRESS_GOAL=$(jq -r ".in_progress[$i]" goals.json)
                  MESSAGE="$MESSAGE
‚Ä¢ $IN_PROGRESS_GOAL"
                done
              fi
              
              if [ $GOALS_COUNT -gt 0 ]; then
                PROGRESS=$((ACHIEVED_COUNT * 100 / GOALS_COUNT))
                MESSAGE="$MESSAGE
üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: $PROGRESS% —Ü–µ–ª–µ–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ"
                
                if [ $PROGRESS -ge 80 ]; then
                  MESSAGE="$MESSAGE
üî• –¢—ã –ø—Ä–æ—Å—Ç–æ —Å—É–ø–µ—Ä! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!"
                elif [ $PROGRESS -ge 50 ]; then
                  MESSAGE="$MESSAGE
üëç –û—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã! –ï—â–µ –Ω–µ–º–Ω–æ–≥–æ!"
                else
                  MESSAGE="$MESSAGE
üí™ –ù–µ —Å–¥–∞–≤–∞–π—Å—è! –ö–∞–∂–¥–∞—è —Ü–µ–ª—å –≤–∞–∂–Ω–∞!"
                fi
              fi
              
              echo "message=$MESSAGE" >> $GITHUB_OUTPUT
            fi
          fi

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–ª—è—Ö
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.process_goals.outputs.message }}
            
            üí° –°–æ–≤–µ—Ç –ø–æ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ü–µ–ª–µ–π:
            –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏–∫—É SMART:
            ‚Ä¢ Specific (–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è)
            ‚Ä¢ Measurable (–ò–∑–º–µ—Ä–∏–º–∞—è)
            ‚Ä¢ Achievable (–î–æ—Å—Ç–∏–∂–∏–º–∞—è)
            ‚Ä¢ Relevant (–ê–∫—Ç—É–∞–ª—å–Ω–∞—è)
            ‚Ä¢ Time-bound (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
            
            üöÄ –°—Ç–∞–≤—å —Ü–µ–ª–∏ –∏ –¥–æ—Å—Ç–∏–≥–∞–π –∏—Ö!

      - name: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if: github.event.inputs.goal
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add goals.json
          git commit -m "–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ü–µ–ª—å: ${{ github.event.inputs.goal }}" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push || echo "–ù–µ—á–µ–≥–æ –ø—É—à–∏—Ç—å"
